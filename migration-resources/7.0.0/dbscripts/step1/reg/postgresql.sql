DO $$ DECLARE create_index_sql TEXT; BEGIN IF NOT EXISTS ( SELECT 1 FROM pg_index i WHERE i.indrelid = 'reg_resource_property'::regclass AND i.indisvalid = true AND ( SELECT array_agg(a.attname::text ORDER BY x.ordinality) FROM unnest(i.indkey) WITH ORDINALITY AS x(attnum, ordinality) JOIN pg_attribute a ON a.attrelid = i.indrelid AND a.attnum = x.attnum ) = ARRAY['reg_tenant_id', 'reg_property_id'] ) THEN SELECT 'CREATE INDEX reg_resc_prop_by_prop_id_ti ON reg_resource_property(reg_tenant_id, reg_property_id)' INTO create_index_sql; EXECUTE create_index_sql; END IF; END $$;
